name: Build and Release

on:
  push:
    branches: [master]
  workflow_dispatch:  # Allow manual trigger
  schedule:
    # Run daily at 6 AM UTC (if there were changes)
    - cron: '0 6 * * *'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # Check if there are new commits (for scheduled runs)
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: check
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # For scheduled runs, check if there were commits in the last 24 hours
            COMMITS=$(git log --since="24 hours ago" --oneline | wc -l)
            if [ "$COMMITS" -gt 0 ]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "Found $COMMITS commits in last 24 hours, will build"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "No commits in last 24 hours, skipping build"
            fi
          else
            # For push and manual triggers, always build
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # Build Desktop versions (Windows, macOS, Linux)
  build-desktop:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            name: Windows-x64
          - os: macos-latest
            rid: osx-arm64
            name: macOS-ARM64
          - os: macos-13
            rid: osx-x64
            name: macOS-x64
          - os: ubuntu-latest
            rid: linux-x64
            name: Linux-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Restore dependencies
        run: dotnet restore Platforms/AgValoniaGPS.Desktop/AgValoniaGPS.Desktop.csproj

      - name: Build and Publish
        run: |
          dotnet publish Platforms/AgValoniaGPS.Desktop/AgValoniaGPS.Desktop.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o publish/${{ matrix.name }}

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        run: Compress-Archive -Path publish/${{ matrix.name }}/* -DestinationPath AgValoniaGPS-${{ matrix.name }}.zip
        shell: pwsh

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        run: |
          cd publish
          zip -r ../AgValoniaGPS-${{ matrix.name }}.zip ${{ matrix.name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgValoniaGPS-${{ matrix.name }}
          path: AgValoniaGPS-${{ matrix.name }}.zip
          retention-days: 30

  # Build Android APK
  build-android:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Install Android workload
        run: dotnet workload install android

      - name: Restore dependencies
        run: dotnet restore Platforms/AgValoniaGPS.Android/AgValoniaGPS.Android.csproj

      - name: Build Android APK
        run: |
          dotnet publish Platforms/AgValoniaGPS.Android/AgValoniaGPS.Android.csproj \
            -c Release \
            -f net10.0-android \
            -o publish/android

      - name: Find and rename APK
        run: |
          APK=$(find publish/android -name "*.apk" | head -1)
          if [ -n "$APK" ]; then
            cp "$APK" AgValoniaGPS-Android.apk
          else
            echo "No APK found!"
            exit 1
          fi

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgValoniaGPS-Android
          path: AgValoniaGPS-Android.apk
          retention-days: 30

  # Build iOS (Simulator + Device if certificates available)
  build-ios:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: 'preview'

      - name: Install iOS workload
        run: dotnet workload install ios

      - name: Restore dependencies
        run: dotnet restore Platforms/AgValoniaGPS.iOS/AgValoniaGPS.iOS.csproj

      # Always build simulator version
      - name: Build iOS (Simulator)
        run: |
          dotnet build Platforms/AgValoniaGPS.iOS/AgValoniaGPS.iOS.csproj \
            -c Release \
            -f net10.0-ios \
            -r iossimulator-arm64

      - name: Create iOS Simulator artifact
        run: |
          cd Platforms/AgValoniaGPS.iOS/bin/Release/net10.0-ios/iossimulator-arm64
          zip -r ${{ github.workspace }}/AgValoniaGPS-iOS-Simulator.zip AgValoniaGPS.iOS.app

      - name: Upload iOS Simulator artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgValoniaGPS-iOS-Simulator
          path: AgValoniaGPS-iOS-Simulator.zip
          retention-days: 30

      # Build device version if signing secrets are available
      - name: Check for iOS signing secrets
        id: check-secrets
        run: |
          if [ -n "${{ secrets.IOS_CERTIFICATE_P12 }}" ] && [ -n "${{ secrets.IOS_PROVISIONING_PROFILE }}" ]; then
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          else
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "iOS signing secrets not configured - skipping device build"
          fi

      - name: Install Apple certificate
        if: steps.check-secrets.outputs.has_secrets == 'true'
        env:
          P12_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ github.run_id }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate
          echo -n "$P12_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Install provisioning profile
        if: steps.check-secrets.outputs.has_secrets == 'true'
        env:
          PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo -n "$PROVISIONING_PROFILE" | base64 --decode -o $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build iOS (Device)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          dotnet publish Platforms/AgValoniaGPS.iOS/AgValoniaGPS.iOS.csproj \
            -c Release \
            -f net10.0-ios \
            -r ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:CodesignKey="${{ secrets.IOS_CODESIGN_IDENTITY }}" \
            -p:CodesignProvision="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}"

      - name: Create iOS Device artifact
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          # Find the .ipa file
          IPA=$(find Platforms/AgValoniaGPS.iOS/bin/Release -name "*.ipa" | head -1)
          if [ -n "$IPA" ]; then
            cp "$IPA" AgValoniaGPS-iOS-Device.ipa
          else
            # If no IPA, create from .app
            cd Platforms/AgValoniaGPS.iOS/bin/Release/net10.0-ios/ios-arm64
            mkdir -p Payload
            cp -r AgValoniaGPS.iOS.app Payload/
            zip -r ${{ github.workspace }}/AgValoniaGPS-iOS-Device.ipa Payload
          fi

      - name: Upload iOS Device artifact
        if: steps.check-secrets.outputs.has_secrets == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: AgValoniaGPS-iOS-Device
          path: AgValoniaGPS-iOS-Device.ipa
          retention-days: 30

      - name: Cleanup keychain
        if: always() && steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  # Create a release with all artifacts
  create-release:
    needs: [build-desktop, build-android, build-ios]
    if: always() && needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version and date
        id: version
        run: |
          # Try to get version from version.h if it exists
          if [ -f "sys/version.h" ]; then
            VERSION=$(grep -oP 'VERSION\s+"\K[^"]+' sys/version.h || echo "0.0.0")
          else
            VERSION="0.0.0"
          fi
          DATE=$(date +'%Y%m%d')
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "tag=nightly-${DATE}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: List artifacts
        run: find artifacts -type f \( -name "*.zip" -o -name "*.apk" -o -name "*.ipa" \) | head -20

      - name: Delete existing nightly release
        run: |
          gh release delete ${{ steps.version.outputs.tag }} --yes || true
          git push origin :refs/tags/${{ steps.version.outputs.tag }} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Nightly Build - ${{ steps.version.outputs.date }}"
          body: |
            ## Automated Nightly Build

            **Date:** ${{ steps.version.outputs.date }}
            **Commit:** ${{ steps.version.outputs.short_sha }}
            **Version:** ${{ steps.version.outputs.version }}

            ### Downloads

            | Platform | File |
            |----------|------|
            | Windows x64 | `AgValoniaGPS-Windows-x64.zip` |
            | macOS ARM64 (M1/M2/M3) | `AgValoniaGPS-macOS-ARM64.zip` |
            | macOS x64 (Intel) | `AgValoniaGPS-macOS-x64.zip` |
            | Linux x64 | `AgValoniaGPS-Linux-x64.zip` |
            | Android | `AgValoniaGPS-Android.apk` |
            | iOS Simulator | `AgValoniaGPS-iOS-Simulator.zip` |
            | iOS Device | `AgValoniaGPS-iOS-Device.ipa` (if signed) |

            ### Installation Notes
            - **Windows**: Extract and run the .exe
            - **macOS**: Extract, right-click the app and select "Open" (first time only)
            - **Linux**: Extract, `chmod +x` the binary, then run
            - **Android**: Enable "Install from unknown sources", then install the APK
            - **iOS Simulator**: For ARM64 Macs - extract and drag to simulator
            - **iOS Device**: Requires signing - install via Xcode or TestFlight

            ### Setting up iOS Device Builds
            To enable iOS device builds, add these secrets to your repository:
            - `IOS_CERTIFICATE_P12`: Base64-encoded .p12 certificate
            - `IOS_CERTIFICATE_PASSWORD`: Certificate password
            - `IOS_PROVISIONING_PROFILE`: Base64-encoded .mobileprovision
            - `IOS_PROVISIONING_PROFILE_NAME`: Profile name (e.g., "AgValoniaGPS Development")
            - `IOS_CODESIGN_IDENTITY`: Signing identity (e.g., "Apple Development: Your Name (XXXXXXXXXX)")

            ---
            *Built automatically from the latest master branch*
          draft: false
          prerelease: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.apk
            artifacts/**/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
