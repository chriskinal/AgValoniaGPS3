<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:AgValoniaGPS.ViewModels"
        xmlns:controls="clr-namespace:AgValoniaGPS.Views.Controls;assembly=AgValoniaGPS.Views"
        xmlns:panels="clr-namespace:AgValoniaGPS.Views.Controls.Panels;assembly=AgValoniaGPS.Views"
        xmlns:dialogs="clr-namespace:AgValoniaGPS.Views.Controls.Dialogs;assembly=AgValoniaGPS.Views"
        mc:Ignorable="d" d:DesignWidth="1366" d:DesignHeight="768"
        x:Class="AgValoniaGPS.Desktop.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="AgValoniaGPS"
        Background="#1a1a1a">

    <!-- Styles are now in shared SharedStyles.axaml -->

    <!-- Main content with dialog overlays -->
    <Panel>
    <!-- Main Grid with OpenGL as background -->
    <Grid>
        <!-- Map Render Area (fills entire window) with pointer events -->
        <!-- Platform-specific map control is created at runtime in code-behind -->
        <ContentControl x:Name="MapControlContainer" ZIndex="0"
                        PointerPressed="MapOverlay_PointerPressed"
                        PointerMoved="MapOverlay_PointerMoved"
                        PointerReleased="MapOverlay_PointerReleased"
                        PointerWheelChanged="MapOverlay_PointerWheelChanged" />

        <!-- TOP STATUS BAR: RTK Status and FPS -->
        <Border Classes="FloatingPanel"
                ZIndex="10"
                Margin="20"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                IsHitTestVisible="True">
            <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Text="RTK Status" Foreground="#3498DB" FontSize="14" FontWeight="Bold"/>
                <Ellipse Width="12" Height="12"
                         Fill="{Binding State.Vehicle.FixQualityText, Converter={StaticResource FixQualityToColorConverter}}"/>
                <TextBlock Text="{Binding State.Vehicle.FixQualityText}" Foreground="White" FontSize="14" FontWeight="Bold"/>
                <Rectangle Width="1" Height="16" Fill="#555" Margin="5,0"/>
                <TextBlock Text="{Binding CurrentFps, StringFormat='FPS: {0:F0}'}" Foreground="#2ECC71" FontSize="14" FontWeight="Bold"/>
                <Rectangle Width="1" Height="16" Fill="#555" Margin="5,0"/>
                <TextBlock Text="{Binding GpsToPgnLatencyMs, StringFormat='Lat: {0:F2}ms'}" Foreground="#F39C12" FontSize="14" FontWeight="Bold"/>
            </StackPanel>
        </Border>

        <!-- TOP RIGHT: Field Statistics Panel -->
        <Border Classes="FloatingPanel"
                ZIndex="10"
                Margin="20"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                IsHitTestVisible="True"
                IsVisible="{Binding HasActiveField}">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock Text="Field:" Foreground="#888" FontSize="13"/>
                    <TextBlock Text="{Binding BoundaryAreaDisplay}" Foreground="White" FontSize="13" FontWeight="Bold"/>
                </StackPanel>
                <Rectangle Width="1" Height="16" Fill="#555"/>
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock Text="Done:" Foreground="#888" FontSize="13"/>
                    <TextBlock Text="{Binding WorkedAreaDisplay}" Foreground="#2ECC71" FontSize="13" FontWeight="Bold"/>
                </StackPanel>
                <Rectangle Width="1" Height="16" Fill="#555"/>
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock Text="Left:" Foreground="#888" FontSize="13"/>
                    <TextBlock Text="{Binding RemainingPercent, StringFormat='{}{0:F1}%'}" Foreground="#F39C12" FontSize="13" FontWeight="Bold"/>
                </StackPanel>
                <Rectangle Width="1" Height="16" Fill="#555"/>
                <StackPanel Orientation="Horizontal" Spacing="4">
                    <TextBlock Text="Rate:" Foreground="#888" FontSize="13"/>
                    <TextBlock Text="{Binding WorkRateDisplay}" Foreground="#3498DB" FontSize="13" FontWeight="Bold"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- All Draggable Panels in single Canvas (must be in same Canvas for consistent drag bounds) -->
        <Canvas ZIndex="10">
            <!-- LEFT SIDEBAR: Main Navigation Panel (Draggable & Rotatable) -->
            <panels:LeftNavigationPanel x:Name="LeftNavPanel"
                                        Canvas.Left="20" Canvas.Top="100"
                                        DataContext="{Binding}"/>

            <!-- RIGHT SIDEBAR: Guidance Control Panel (Draggable & Rotatable) -->
            <panels:RightNavigationPanel x:Name="RightNavPanel"
                                         Canvas.Right="20" Canvas.Top="100"
                                         DataContext="{Binding}"/>

            <!-- Section Control Panel (Draggable) -->
            <panels:SectionControlPanel x:Name="SectionControlPanel"
                                        Canvas.Left="900" Canvas.Top="600"
                                        Cursor="Hand"
                                        DataContext="{Binding}"
                                        PointerPressed="SectionControl_PointerPressed"
                                        PointerMoved="SectionControl_PointerMoved"
                                        PointerReleased="SectionControl_PointerReleased"/>

            <!-- Bottom Navigation Panel (Draggable & Rotatable) -->
            <panels:BottomNavigationPanel x:Name="BottomNavPanel"
                                          Canvas.Left="200" Canvas.Top="600"
                                          DataContext="{Binding}"/>
        </Canvas>
    </Grid>

    <!-- AB Creation Instruction Banner -->
    <Border Background="#CC000000" CornerRadius="8" Padding="16,8"
            HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,80,0,0"
            IsVisible="{Binding IsCreatingABLine}">
        <StackPanel Orientation="Horizontal" Spacing="16">
            <TextBlock Text="{Binding ABCreationInstructions}"
                       Foreground="White" FontSize="16" VerticalAlignment="Center"/>
            <Button Content="Cancel"
                    Command="{Binding CancelABCreationCommand}"
                    Background="#DD3333" Foreground="White"
                    Padding="12,4"/>
        </StackPanel>
    </Border>

    <!-- Modal Dialog Overlays (shared across platforms) -->
    <controls:DialogOverlayHost DataContext="{Binding}"/>
    </Panel>
</Window>
