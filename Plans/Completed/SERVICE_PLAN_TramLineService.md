# Feature: TramLineService

## Overview

Generate and display tram lines (tramlines) for controlled traffic farming (CTF). Tram lines are permanent wheel tracks that follow the field boundary and guidance tracks, allowing tractors to always drive in the same paths to reduce soil compaction.

## WinForms Reference

### Files
- `GPS/Classes/CTram.cs` - Tram line generation and rendering
- `GPS/Forms/Guidance/FormTramLine.cs` - Tram line configuration dialog
- `AgOpenGPS.Core/Models/Field/TramLines.cs` - Core model
- `AgOpenGPS.Core/Services/TramlineService.cs` - Core offset calculations
- `AgOpenGPS.Core/Streamers/Field/TramLinesStreamer.cs` - File I/O

### Key Variables

```csharp
// From CTram.cs
public class CTram
{
    // Boundary-offset tram tracks (follow field boundary)
    public List<vec2> tramBndOuterArr = new List<vec2>();  // Outer wheel track
    public List<vec2> tramBndInnerArr = new List<vec2>();  // Inner wheel track

    // Parallel tram lines from guidance track
    public List<vec2> tramArr = new List<vec2>();          // Current tram line
    public List<List<vec2>> tramList = new List<List<vec2>>(); // All tram lines

    // Settings
    public double tramWidth;        // Width between tram line passes (tool width multiple)
    public double halfWheelTrack;   // Half the vehicle track width
    public int passes;              // Number of passes between tram lines
    public double alpha;            // Display transparency

    // Display modes: 0=off, 1=all, 2=lines only, 3=outer only
    public int displayMode;

    // Manual overrides
    public bool isLeftManualOn, isRightManualOn;
}
```

### Core Algorithm

Tram lines are generated by offsetting from the boundary:

```csharp
// Determine if outer or inner tram based on tool width multiple
public void IsTramOuterOrInner()
{
    // If tram width is even multiple of tool width, use outer position
    isOuter = ((int)(tramWidth / tool.width + 0.5)) % 2 == 0;
    if (isTramOuterInverted) isOuter = !isOuter;
}

// Generate outer boundary tram track
public void CreateBndOuterTramTrack()
{
    // Use Core service to offset fence line by (tramWidth + halfWheelTrack)
    List<Vec2> coreOuterTramline = _coreService.GenerateOuterTramline(
        coreFenceLine,
        tramWidth,
        halfWheelTrack);

    tramBndOuterArr = ConvertToWinForms(coreOuterTramline);
}

// Generate inner boundary tram track
private void CreateBndInnerTramTrack()
{
    // Use Core service to offset fence line by (tramWidth - halfWheelTrack)
    List<Vec2> coreInnerTramline = _coreService.GenerateInnerTramline(
        coreFenceLine,
        tramWidth,
        halfWheelTrack);

    tramBndInnerArr = ConvertToWinForms(coreInnerTramline);
}
```

### TramLines Model

```csharp
// From AgOpenGPS.Core/Models/Field/TramLines.cs
public class TramLines
{
    public GeoPolygon OuterTrack { get; set; }   // Outer wheel boundary track
    public GeoPolygon InnerTrack { get; set; }   // Inner wheel boundary track
    public List<GeoPath> TramList { get; set; }  // Parallel tram lines

    public bool IsEmpty => TramList.Count == 0 && OuterTrack == null;
}
```

## Config Settings Used

From `ConfigurationStore.Instance.Tool`:
- `Width` - Tool working width (for tram spacing calculation)

From `ConfigurationStore.Instance.Vehicle`:
- `TrackWidth` - Vehicle wheel track width

From `ConfigurationStore.Instance.Tram` (new section needed):
- `TramWidth` - Width between tram passes (typically 2x or 3x tool width)
- `Passes` - Number of passes between tram lines (e.g., 3 = every 3rd pass)
- `Alpha` - Display transparency
- `DisplayMode` - 0=off, 1=all, 2=lines only, 3=outer only
- `GenerateMode` - Generation method
- `IsOuterInverted` - Invert outer/inner determination

## Proposed Interface

```csharp
public interface ITramLineService
{
    // Current tram lines
    IReadOnlyList<Vec2> OuterBoundaryTrack { get; }
    IReadOnlyList<Vec2> InnerBoundaryTrack { get; }
    IReadOnlyList<IReadOnlyList<Vec2>> ParallelTramLines { get; }

    // Generate from boundary
    void GenerateBoundaryTramLines(IReadOnlyList<Vec3> fenceLine);

    // Generate from guidance track
    void GenerateParallelTramLines(Track referenceTrack, int passCount);

    // Query
    bool IsOnTramLine(Vec3 position, double tolerance);
    double DistanceToNearestTramLine(Vec3 position);

    // Manual control
    bool IsLeftManualOn { get; set; }
    bool IsRightManualOn { get; set; }

    // Clear
    void Clear();

    // File I/O
    void SaveToFile(string fieldDirectory);
    void LoadFromFile(string fieldDirectory);

    // Events
    event EventHandler TramLinesUpdated;
}
```

## Dependencies

### Required Services
- `IFieldService` - Access boundary fence line
- `ITrackGuidanceService` - Access current guidance track

### Required Config
- `ConfigurationStore.Instance.Tool` for tool width
- `ConfigurationStore.Instance.Vehicle` for track width
- `ConfigurationStore.Instance.Tram` (new) for tram-specific settings

### Existing Core Code
- `AgOpenGPS.Core/Services/TramlineService.cs` - Already has offset calculation logic

## Implementation Steps

1. [ ] Create `ITramLineService` interface in `Services/Interfaces/`
2. [ ] Add `TramConfiguration` to `Models/Configuration/TramConfiguration.cs`
3. [ ] Add `Tram` property to `ConfigurationStore`
4. [ ] Create `TramLineService` class in `Services/Tram/`
5. [ ] Port boundary offset generation from Core TramlineService
6. [ ] Implement parallel tram line generation from guidance tracks
7. [ ] Implement on-tram-line query for section control integration
8. [ ] Implement file I/O (TramLines.txt)
9. [ ] Add DI registration
10. [ ] Add tram line rendering to DrawingContextMapControl
11. [ ] Create TramConfigTab for configuration dialog
12. [ ] Wire to MainViewModel for display toggle
13. [ ] Test with simulator and real boundary

## UI Requirements

### Configuration Dialog (TramConfigTab)
- Tram width setting (numeric input)
- Passes between tram lines (numeric input)
- Display mode selection (Off, All, Lines, Outer)
- Display transparency slider
- Invert outer/inner checkbox
- Generate button

### Map Display
- Outer boundary track: Dark line with colored overlay
- Inner boundary track: Same style offset inward
- Parallel tram lines: Lighter weight lines
- Display transparency controlled by alpha setting

## Rendering

```csharp
public void RenderTramLines(DrawingContext dc, ITramLineService tramService)
{
    if (tramService.OuterBoundaryTrack.Count == 0) return;

    var pen = new Pen(Brushes.Black, 3);
    var colorPen = new Pen(new SolidColorBrush(Color.FromArgb(alpha, 238, 184, 188)), 2);

    // Draw outer track
    DrawPolyline(dc, tramService.OuterBoundaryTrack, pen);
    DrawPolyline(dc, tramService.OuterBoundaryTrack, colorPen);

    // Draw inner track
    DrawPolyline(dc, tramService.InnerBoundaryTrack, pen);
    DrawPolyline(dc, tramService.InnerBoundaryTrack, colorPen);

    // Draw parallel tram lines
    foreach (var tramLine in tramService.ParallelTramLines)
    {
        DrawPolyline(dc, tramLine, pen);
        DrawPolyline(dc, tramLine, colorPen);
    }
}
```

## Priority

**Low** - Advanced feature for controlled traffic farming. Not required for basic operation but important for users practicing CTF to reduce soil compaction.

## Notes

- Tram lines help prevent soil compaction by concentrating wheel traffic
- Outer/inner tracks follow the headland boundary
- Parallel tram lines are generated every N passes of the guidance track
- Left/right manual override allows forcing tram recording regardless of pass count
- Core TramlineService already exists and can be leveraged

## Existing Code to Reuse

- `AgOpenGPS.Core/Services/TramlineService.cs` - Offset calculations
- `AgOpenGPS.Core/Models/Field/TramLines.cs` - Data model
- `AgOpenGPS.Core/Streamers/Field/TramLinesStreamer.cs` - File I/O

